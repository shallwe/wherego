// Generated by CoffeeScript 1.8.0
(function() {
  var loadCity, main, setCities, setCity, setRandomCity, toggleRandomCity;

  this.toChoseCity = {};

  setRandomCity = (function(_this) {
    return function() {
      var name, names;
      names = _.keys(_this.toChoseCity);
      name = names[_.random(0, names.length - 1)];
      return setCity(name, _this.toChoseCity[name]);
    };
  })(this);

  setCities = (function(_this) {
    return function(name, cities) {
      var data, nameMap;
      data = [];
      _.map(cities, function(value, city) {
        return data.push({
          name: city,
          value: value.pos.concat(value.pr)
        });
      });
      nameMap = {
        old_city: '历史文化名城',
        unusual_city: '冷门旅游城市'
      };
      return _this.mapChart.setOption({
        title: {
          text: nameMap[name]
        },
        series: {
          type: 'scatter',
          coordinateSystem: 'geo',
          symbolSize: 4,
          itemStyle: {
            normal: {
              color: 'green'
            }
          },
          data: data
        }
      });
    };
  })(this);

  setCity = (function(_this) {
    return function(name, pos) {
      var data, series;
      data = [
        {
          name: name,
          value: pos.concat(name)
        }
      ];
      series = _this.mapChart.getOption().series;
      if (series.length > 1) {
        series = _.reject(series, {
          name: '选中城市'
        });
      }
      series.push({
        name: '选中城市',
        type: 'scatter',
        coordinateSystem: 'geo',
        symbolSize: 10,
        label: {
          normal: {
            show: true,
            formatter: '{b}',
            position: 'top'
          }
        },
        itemStyle: {
          normal: {
            color: 'blue'
          }
        },
        data: data
      });
      return _this.mapChart.setOption({
        series: series
      });
    };
  })(this);

  toggleRandomCity = (function(_this) {
    return function() {
      if (_this.interval) {
        clearInterval(_this.interval);
        _this.interval = null;
        $("#go .icon").removeClass('stop');
        return $("#go .icon").addClass('play');
      } else {
        _this.interval = setInterval(setRandomCity, 1000);
        $("#go .icon").removeClass('start');
        return $("#go .icon").addClass('stop');
      }
    };
  })(this);

  loadCity = function(city_name) {
    return fetch("/static/json/" + city_name + ".json").then(function(resp) {
      return resp.json().then(function(cities) {
        window.toChoseCity = cities;
        setCities(city_name, window.toChoseCity);
        return $("#go").removeClass('disabled');
      });
    });
  };

  main = (function(_this) {
    return function() {
      _this.mapChart = echarts.init($("#chart")[0]);
      mapChart.setOption({
        title: {
          text: '我们去哪儿玩',
          textStyle: {
            color: '#555'
          }
        },
        backgroundColor: '#bbbbbb',
        tooltip: {
          show: true,
          showContent: true,
          trigger: 'item',
          position: 'top',
          formatter: '{b}',
          backgroundColor: 'black',
          textStyle: {
            color: '#1a2'
          }
        },
        geo: {
          map: 'china',
          label: {
            emphasis: {
              show: false
            }
          },
          itemStyle: {
            normal: {
              areaColor: '#cca',
              borderColor: '#000'
            }
          },
          selectedMode: 'multiple'
        },
        series: []
      });
      _this.mapChart.on('geoselectchanged', function(params) {
        return console.log(params);
      });
      $('#china-city').click(_.partial(loadCity, 'china_city'));
      $('#old-city').click(_.partial(loadCity, 'old_city'));
      $('#unusual').click(_.partial(loadCity, 'unusual_city'));
      return $("#go").click(toggleRandomCity);
    };
  })(this);

  $(main);

}).call(this);
